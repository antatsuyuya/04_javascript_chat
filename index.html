<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
<style>

</style>

</head>
<body>

    <div id="output" style="overflow: auto;height: 300px;"></div>



    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div>
        <div>
            åå‰ï¼š<input type="text" id="uname">
        </div>
        <div>
            ç”»åƒï¼š<input type="text" id="upload">
        </div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <button id="send">é€ä¿¡</button>
            <!-- <input type="file" id="file" />
            <button id="upload" type="button" id=upload>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button> -->
        </div>
    </div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>   

<!--firebaseã®ã‚³ãƒ¼ãƒ‰-->


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
        from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC72pEjeSxvkzeJh8DhwIriStVPLiCaIRU",
          authDomain: "gsdemo-e7ea8.firebaseapp.com",
          projectId: "gsdemo-e7ea8",
          storageBucket: "gsdemo-e7ea8.appspot.com",
          messagingSenderId: "273052528662",
          appId: "1:273052528662:web:af72f757fa1ad6a9890537"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        //è¿½åŠ 2
        const db  = getDatabase(app); //RealtimeDBã«æ¥ç¶š
        const dbRef = ref(db,"chat"); //RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†

    // é€ä¿¡å‡¦ç†
    // $('#send').on('click', function(){
    //   alert(1)//å‹•ã„ãŸã‚‰alertã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãŠãã¾ã—ã‚‡ã†ï¼
    //   // é€ä¿¡ã®å‡¦ç†ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ğŸ¤—

    // });

        //é€ä¿¡
    $("#send").on("click", function(){
        // ãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’ä½œæˆã—ã¦ã„ã‚‹
        const msg={
            uname : $("#uname").val(),  //id unameã®ã¨ã“ã‚
            // upload : $("#upload").val(),  //id imgã®ã¨ã“ã‚
            text :$("#text").val(),ã€€//id textã®ã¨ã“ã‚
            // upload :$("#upload").val()
        }
      //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ç”Ÿæˆ = çµ¶å¯¾ã«ã‹ã¶ã‚‰ãªã„ç•ªå·ã¿ãŸã„ãªã‚‚ã®
    const newPostRef=push(dbRef);

  //"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
    set(newPostRef, msg);

      });

      //å—ä¿¡å‡¦ç†
      onChildAdded(dbRef, function(data){
        const msg = data.val();
        const key = data.key;//ã“ã‚ŒãŒå›ºæœ‰ã®ã‚«ã‚®
    console.log(data,"data")
    console.log(key,"éµ")

        // let h ="<p>";
        //     h += msg.uname;
        //     h += "<br>";
        //     h += msg.text;
        //     h +="</p>";
        //     $("#output").append(h);
    

  //ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
    let hh = `
    <div class="meessage" data-key=${key}>
        <input type="text" value=${msg.uname} class="uname"/>
        <input type="text" value=${msg.text} class="text"/>
        <input type="image" value=${msg.upload} class="upload">
        <p class="update">æ›´æ–°</p>
        <p class="delete">å‰Šé™¤</p>
    </div>`;

    $("#output").append(hh);

});//hhãŒã‚«ã‚®


$(document).on("click", ".update",function(){
    //clickã•ã‚ŒãŸã¨ã“ã‚ã®éµ
    const x = $(this).parent().data().key;

    const nameValue = $(this).siblings(".uname").val();
    // const imgValue= $(this).siblings(".img").val();
    const textValue = $(this).siblings(".text").val();

    console.log(nameValue,"åŒã˜åˆ—")
    // console.log(imgValue,"åŒã˜åˆ—")
    console.log(textValue,"åŒã˜åˆ—")
    
    set(ref(db, "chat/" +x,"update") , {
    uname : nameValue,
    // imd : imgValue,
    text : textValue
})
});



$(document).on("click", ".delete",function(){
    //clickã•ã‚ŒãŸã¨ã“ã‚ã®éµ
    const v = $(this).parent().data().key;
    
    console.log(v,"vvv")
    //vã¯éµ
    console.log(ref(db,"chat/"+v),"vvv")
    remove(ref(db,"chat/"+v,"vvv"));
    
    //htmlã‚’æ¶ˆã™
    $(this).parent().remove();

});

$(document).on("click",'upload', function() {
    const y = $(this).parent().data().key;
    const imageUrl = $(this).siblings(".img").val();

    set(ref(db, "chat/" +y,"upload") , {
    imd : imageUrl
})
}); 

       


//  //ç”»åƒæŠ•ç¨¿
//        $("#into").on("click", function(){
//         // ãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’ä½œæˆã—ã¦ã„ã‚‹
//         const msg={
//             uname : $("#uname").val(),  //id unameã®ã¨ã“ã‚
//             text :$("#text").val()ã€€//id textã®ã¨ã“ã‚
//         }
//       //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ç”Ÿæˆ = çµ¶å¯¾ã«ã‹ã¶ã‚‰ãªã„ç•ªå·ã¿ãŸã„ãªã‚‚ã®
//     const newPostRef=push(dbRef);

//   //"chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
//     set(newPostRef, msg);

//       });






     //firebaseã§ãã‚‹ã“ã¨ãŒå¤šã„ã€€é…åˆ—ï¼ˆareyï¼‰ã€objectï¼ˆï¼‰ç”»åƒæŠ•ç¨¿
     //

    //  jquery parent()ãŠã•ã‚‰ã„
    //  jquery remove
    //  jquery data()
    //  jquery å‹•çš„è¿½åŠ 
    //  jquery siblings


</script>
 <!--   <script src="test.js"></script> -->

</body>
</html>